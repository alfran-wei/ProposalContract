<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal DApp - Sepolia Testnet</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div class="container">
    <header>
      <h1>üó≥Ô∏è Proposal DApp</h1>
      <p>Vote on decentralized proposals ‚Äî Sepolia Testnet</p>
    </header>

    <section class="wallet">
      <button id="connectBtn">ü¶ä Connect MetaMask</button>
      <p id="account"></p>
    </section>

    <section>
      <h2>üìã All Proposals</h2>
      <div id="proposalList">
        <div class="loading-proposals">
          <div class="spinner"></div>
          <p style="color: #6b7280; font-size: 1.2rem;">Loading proposals...</p>
        </div>
      </div>
    </section>

    <section class="create">
      <h2>Create Proposal</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 0.5fr; gap: 1rem; align-items: end;">
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600; font-size: 0.9rem;">Title</label>
          <input type="text" id="title" placeholder="Proposal title" style="margin-bottom: 0;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600; font-size: 0.9rem;">Description</label>
          <input type="text" id="desc" placeholder="Description" style="margin-bottom: 0;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600; font-size: 0.9rem;">Vote limit</label>
          <input type="number" id="limit" placeholder="Limit" min="1" style="margin-bottom: 0;">
        </div>
        <button id="createBtn" style="margin-bottom: 0;">‚ú® Create</button>
      </div>
    </section>
  </div>

  <footer>
    <p>üíß Need Sepolia ETH? <a href="https://cloud.google.com/application/web3/faucet/ethereum/sepolia" target="_blank">Get it here</a></p>
    <p>Built by <strong>Alfran Essone</strong> ¬© 2025</p>
  </footer>

  <script>
    let web3;
    let contract;
    const contractAddress = "0xF5413a613C086c703760b77FC15423bd82f1F57C";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "closeProposal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_description",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "_total_vote_to_end",
				"type": "uint256"
			}
		],
		"name": "create",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "new_owner",
				"type": "address"
			}
		],
		"name": "setOwner",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "proposalId",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "choice",
				"type": "uint8"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "counter",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllProposals",
		"outputs": [
			{
				"components": [
					{
						"components": [
							{
								"internalType": "string",
								"name": "title",
								"type": "string"
							},
							{
								"internalType": "uint256",
								"name": "date",
								"type": "uint256"
							},
							{
								"internalType": "string",
								"name": "total_description",
								"type": "string"
							}
						],
						"internalType": "struct ProposalContract.MoreDescription",
						"name": "description",
						"type": "tuple"
					},
					{
						"internalType": "uint256",
						"name": "approve",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "reject",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "pass",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "total_vote_to_end",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "current_state",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "is_active",
						"type": "bool"
					},
					{
						"internalType": "address[]",
						"name": "voters",
						"type": "address[]"
					}
				],
				"internalType": "struct ProposalContract.Proposal[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			}
		],
		"name": "getProposal",
		"outputs": [
			{
				"components": [
					{
						"components": [
							{
								"internalType": "string",
								"name": "title",
								"type": "string"
							},
							{
								"internalType": "uint256",
								"name": "date",
								"type": "uint256"
							},
							{
								"internalType": "string",
								"name": "total_description",
								"type": "string"
							}
						],
						"internalType": "struct ProposalContract.MoreDescription",
						"name": "description",
						"type": "tuple"
					},
					{
						"internalType": "uint256",
						"name": "approve",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "reject",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "pass",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "total_vote_to_end",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "current_state",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "is_active",
						"type": "bool"
					},
					{
						"internalType": "address[]",
						"name": "voters",
						"type": "address[]"
					}
				],
				"internalType": "struct ProposalContract.Proposal",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "voter",
				"type": "address"
			}
		],
		"name": "hasVoted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "proposal_history",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "title",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "date",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "total_description",
						"type": "string"
					}
				],
				"internalType": "struct ProposalContract.MoreDescription",
				"name": "description",
				"type": "tuple"
			},
			{
				"internalType": "uint256",
				"name": "approve",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "reject",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "pass",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "total_vote_to_end",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "current_state",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "is_active",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // (ABI content unchanged)

    async function connect() {
      try {
        if (window.ethereum) {
          web3 = new Web3(window.ethereum);
          await ethereum.request({ method: "eth_requestAccounts" });
          const accounts = await web3.eth.getAccounts();
          document.getElementById("account").innerText = `‚úÖ Connected: ${accounts[0]}`;
          contract = new web3.eth.Contract(contractABI, contractAddress);
          loadProposals();
        } else {
          alert("‚ùå Please install MetaMask to use this DApp!");
        }
      } catch (error) {
        console.error(error);
        alert("Connection error: " + error.message);
      }
    }

    document.getElementById("connectBtn").onclick = connect;

    async function createProposal() {
      const btn = document.getElementById("createBtn");
      const originalText = btn.innerHTML;
      
      try {
        const title = document.getElementById("title").value;
        const desc = document.getElementById("desc").value;
        const limit = document.getElementById("limit").value;
        
        if (!title || !desc || !limit) return alert("‚ö†Ô∏è Please fill in all fields!");
        
        btn.disabled = true;
        btn.innerHTML = 'Creating... <span class="loading"></span>';
        
        const accounts = await web3.eth.getAccounts();
        await contract.methods.create(title, desc, limit).send({ from: accounts[0] });
        
        alert("‚úÖ Proposal successfully created!");
        document.getElementById("title").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("limit").value = "";
        
        loadProposals();
      } catch (error) {
        console.error(error);
        alert("‚ùå Error: " + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    document.getElementById("createBtn").onclick = createProposal;

    async function loadProposals() {
      try {
        // Display loading spinner
        document.getElementById("proposalList").innerHTML = `
          <div class="loading-proposals">
            <div class="spinner"></div>
            <p style="color: #6b7280; font-size: 1.2rem;">Loading proposals...</p>
          </div>
        `;
        
        const proposals = await contract.methods.getAllProposals().call();
        let html = "";
        
        if (proposals.length === 0) {
          html = `
            <div class="empty-state">
              <div class="emoji">üì≠</div>
              <p>No proposals at the moment.</p>
              <p style="font-size: 1rem; margin-top: 1rem; color: #9ca3af;">Be the first to create one!</p>
            </div>
          `;
        } else {
          proposals.forEach((p, i) => {
            const id = i + 1;
            const date = new Date(Number(p.description.date) * 1000).toLocaleString('en-US');
            const statusClass = p.is_active ? 'status-active' : 'status-closed';
            const statusText = p.is_active ? 'üü¢ Active' : 'üî¥ Closed';
            
            html += `
              <div class="card">
                <h3>Proposal #${id} ‚Äî ${p.description.title}</h3>
                <p><strong>Description:</strong> ${p.description.total_description}</p>
                <p><strong>Created on:</strong> ${date}</p>
                
                <div class="votes-summary">
                  <span class="vote-item">‚úÖ Approve: ${p.approve}</span>
                  <span class="vote-item">‚ùå Reject: ${p.reject}</span>
                  <span class="vote-item">‚è≠Ô∏è Pass: ${p.pass}</span>
                </div>
                
                <p><span class="${statusClass}">${statusText}</span></p>
                
                ${p.is_active ? `
                  <div style="margin-top: 1.5rem;">
                    <button class="btn-approve" onclick="vote(${id}, 1)">‚úÖ Approve</button>
                    <button class="btn-reject" onclick="vote(${id}, 2)">‚ùå Reject</button>
                    <button class="btn-pass" onclick="vote(${id}, 0)">‚è≠Ô∏è Pass</button>
                  </div>
                ` : '<p style="margin-top: 1rem; color: #9ca3af; font-style: italic;">This proposal is closed</p>'}
              </div>
            `;
          });
        }
        
        document.getElementById("proposalList").innerHTML = html;
      } catch (error) {
        console.error(error);
        document.getElementById("proposalList").innerHTML = `
          <div class="empty-state">
            <div class="emoji">‚ùå</div>
            <p>Error while loading proposals</p>
            <p style="font-size: 1rem; margin-top: 1rem; color: #9ca3af;">Make sure you are connected to the Sepolia network</p>
          </div>
        `;
      }
    }

    async function vote(id, choice) {
      const choiceNames = {0: "Pass", 1: "Approve", 2: "Reject"};
      
      try {
        const accounts = await web3.eth.getAccounts();
        
        // Disable all vote buttons for this card
        const buttons = document.querySelectorAll(`button[onclick*="vote(${id}"]`);
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.innerHTML = 'Voting... <span class="loading"></span>';
        });
        
        await contract.methods.vote(id, choice).send({ from: accounts[0] });
        
        alert(`‚úÖ Vote "${choiceNames[choice]}" recorded for Proposal #${id}`);
        loadProposals();
      } catch (error) {
        console.error(error);
        alert("‚ùå Error while voting: " + error.message);
        loadProposals(); // Reload to reactivate buttons
      }
    }
  </script>
</body>
</html>
